<html>
  <head>
    <meta charset="UTF-8" />
    <title>My Web Page</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="This is a sample web page." />
  </head>
  <body>
    <!-- Create a input for text, using javascript to get input text -->
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      p {
        text-align: center;
        color: #666;
      }
      table {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px;
        margin: 4px 0;
        box-sizing: border-box;
      }
      button {
        padding: 8px 12px;
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #218838;
      }
      .likeButton {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
      }
      .likeButton:hover {
        background-color: #0056b3;
      }
      .playButton {
        background-color: #ffc107;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
      }
      .playButton:hover {
        background-color: #e0a800;
      }
      #dataTable {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
      }
      #dataTable th,
      #dataTable td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      #dataTable th {
        background-color: #f2f2f2;
      }
      /* Loading as masks */
      #loading {
        text-align: center;
        font-size: 28px;
        padding-top: 48%;
        color: #555;
        display: none; /* Initially hidden */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(
          255,
          255,
          255,
          0.9
        ); /* Semi-transparent background */
        z-index: 1000; /* Ensure it covers other content */
        justify-content: center;
        align-items: center;
      }
      #loading.show {
        display: block; /* Show when needed */
      }
    </style>
    <div id="loading">Loading...</div>
    <h1>永平傳聲筒</h1>
    <p>幫你把愛說出來</p>
    <table>
      <tbody>
        <tr>
          <td>暱稱：</td>
          <td>
            <input type="text" id="userInput" placeholder="輸入暱稱..." />
          </td>
        </tr>
        <tr>
          <td>內容：</td>
          <td>
            <input type="text" id="textInput" placeholder="輸入內容..." />
          </td>
        </tr>
        <tr>
          <td>發送</td>
          <td>
            <button id="submitButton">發送</button>
          </td>
        </tr>
      </tbody>
    </table>

    <table id="dataTable">
      <thead>
        <tr>
          <td>Index</td>
          <td>From</td>
          <td>Content</td>
          <td>Likes</td>
          <td>Action</td>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // Show loading indicator
      function showLoading() {
        const loadingElement = document.getElementById("loading");
        loadingElement.classList.add("show");
      }
      // Hide loading indicator
      function hideLoading() {
        const loadingElement = document.getElementById("loading");
        loadingElement.classList.remove("show");
      }

      // render table with data
      const tableData = [
        {
          index: 1,
          content: "Sample Content 1",
          from: "User A",
          likes: 0,
          status: "done",
          audioContent: "base64-audio-content-1",
        },
        {
          index: 2,
          content: "Sample Content 2",
          from: "User B",
          likes: 0,
          status: "done",
          audioContent: "base64-audio-content-2",
        },
        {
          index: 3,
          content: "Sample Content 3",
          from: "User C",
          likes: 0,
          status: "done",
          audioContent: "base64-audio-content-3",
        },
      ];

      function renderTable() {
        const tbody = document.querySelector("#dataTable tbody");
        tbody.innerHTML = ""; // Clear existing rows

        tableData.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.index}</td>
            <td>${row.from}</td>
            <td>${row.content}</td>
            <td>${row.likes}</td>
            <td><button class="likeButton">Like</button> <button class="playButton">Play</button></td>
          `;
          tbody.appendChild(tr);
        });

        // Add event listeners to like buttons
        const likeButtons = document.querySelectorAll(".likeButton");
        likeButtons.forEach((button, index) => {
          button.addEventListener("click", () => {
            tableData[index].likes += 1;
            renderTable();
          });
        });

        // Add event listeners to play buttons
        const playButtons = document.querySelectorAll(".playButton");
        playButtons.forEach((button, index) => {
          button.addEventListener("click", () => {
            const audioData = tableData[index].audioContent;
            const audio = new Audio("data:audio/wav;base64," + audioData);
            audio
              .play()
              .then(() => {
                console.log("Audio is playing");
              })
              .catch((playError) => {
                console.error("Error playing audio:", playError);
              });
          });
        });
      }

      async function postData() {
        showLoading(); // Show loading indicator
        const user = document.getElementById("userInput").value;
        const inputText = document.getElementById("textInput").value;

        const data = {
          text: inputText,
        };

        axios
          .post("http://localhost:8080/submit", data)
          .then((response) => {
            console.log("Post response:", response.data);

            // new row to the data array
            tableData.push({
              index: tableData.length + 1,
              content: inputText,
              from: user,
              likes: 0,
              status: "done",
              audioContent: response.data.audioContent,
            });
            renderTable();

            hideLoading(); // Hide loading indicator
            document.getElementById("userInput").value = "";
            document.getElementById("textInput").value = "";
          })
          .catch((error) => {
            console.error("Error posting data:", error);
          });
      }

      document
        .getElementById("submitButton")
        .addEventListener("click", async function () {
          await postData();
        });

      // document ready function
      window.onload = function () {
        console.log("Document is ready");
        renderTable();
      };
    </script>
  </body>
</html>
